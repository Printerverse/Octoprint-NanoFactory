<!doctype html>
<html>

<head>
    <title>WebSSH Client</title>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>


        <!-- Xterm.js -->
    <script src="./node_modules/xterm/lib/xterm.js"></script>
    <script src="./node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="./node_modules/xterm-addon-search/lib/xterm-addon-search.js"></script>
    <script src="./node_modules/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <link rel="stylesheet" href="./node_modules/xterm/css/xterm.css" />


    <script src="./wasm_exec.js"></script>
    <script type="text/javascript">
        function fetchAndInstantiate(url, importObject) {
            return fetch(url).then(response =>
                response.arrayBuffer()
            ).then(bytes =>
                WebAssembly.instantiate(bytes, importObject)
            ).then(results =>
                results.instance
            );
        }

        var go = new Go();
        var mod = fetchAndInstantiate("./main.wasm", go.importObject);
        window.onload = function () {
            mod.then(function (instance) {
                go.run(instance);
            });
            notReady = function () {
                return $("portInp").val() == "" || $('#hostInp').val() == "" || $('#usrInp').val() == "" ||
                    ($('#passInp').val() == "" && $('#pkInp').val() == "")
            }
            pkFileOpen = function (evt) {
                const input = event.target
                if ('files' in input && input.files.length > 0) {
                    console.log("open" + input.files[0])
                    placeFileContent(document.getElementById('pkInp'), input.files[0])
                }
            }

            function placeFileContent(target, file) {
                readFileContent(file).then(content => {
                    target.value = content
                    $('#conBtn').prop('disabled', notReady() ? true : false);
                }).catch(error => console.log(error))
            }

            function readFileContent(file) {
                const reader = new FileReader()
                return new Promise((resolve, reject) => {
                    reader.onload = event => resolve(event.target.result)
                    reader.onerror = error => reject(error)
                    reader.readAsText(file)
                })
            }

            showServerKey = function (key) {
                $('#fingerprintMsg').html("RSA key fingerprint is " + key + " <br>Are you sure you want to continue connecting (yes/no)?")
                $('#fingerprintModal').modal('show')
            }

            connected = function (status) {
                showMsg('');
                showErr('');
                $('#msg').hide();
                $('#errMsg').hide()
                $('#conPan').hide();
                $('#conInf').html(status);
            }

            showReconnect = function (errorMsg) {
                $('#connLostMsg').html("The connection to your server was interrupted: " + errorMsg + "<br>Do you want to reconnect?")
                $('#reconnectModal').modal('show')
            }

            reconnect = function (shouldReconnect) {
                if (shouldReconnect) {
                    initConnection(term.rows, term.cols, $('#hostInp').val(), Number($('#portInp').val()), $('#usrInp').val(), $('#passInp').val(), $('#pkInp').val(), $('#bypassProxyInp').is(':checked'), false);
                } else {
                    $('#conPan').show();
                }
            }

            showMsg = function (msg) {
                $('#errMsg').hide()
                $('#msg').show()
                $('#msg').html(msg);
            }

            showErr = function (msg) {
                $('#msg').hide();
                $('#conPan').show();
                $('#conBtn').prop('disabled', false);
                $('#errMsg').show();
                $('#errMsg').html(msg);
            }

            $(document).ready(function () {
                $('#conBtn').prop('disabled', true);
                $('#hostInp').keyup(function () { $('#conBtn').prop('disabled', notReady() ? true : false); })
                $('#portInp').keyup(function () { $('#conBtn').prop('disabled', notReady() ? true : false); })
                $('#usrInp').keyup(function () { $('#conBtn').prop('disabled', notReady() ? true : false); })
                $('#passInp').keyup(function () { $('#conBtn').prop('disabled', notReady() ? true : false); })
                $('#pkInp').keyup(function () { $('#conBtn').prop('disabled', notReady() ? true : false); })
                $('#pkFile').change(pkFileOpen);
                $('#msg').hide()
                $('#errMsg').hide()
            });
            var home = "/";

        };

    </script>
    <style>
        #canvas {
            width: 500px;
            height: 300px;
        }

        .iframe-container {
            overflow: hidden;
            padding-top: 56.25%;
            position: relative;
        }

        .iframe-container iframe {
            border: 0;
            height: 100%;
            left: 0;
            position: absolute;
            top: 0;
            width: 100%;
        }

        .row {
            padding-top: 5px;
        }
    </style>
</head>

<body>
    <div id="fingerprintModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Server fingerprint</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                        onclick="acceptFingerprint(false);">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="fingerprintMsg" class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal"
                        onclick="acceptFingerprint(true);">Yes</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                        onclick="acceptFingerprint(false);">No</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reconnectModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Connection lost</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                        onclick="reconnect(false);">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="connLostMsg" class="modal-body">
                    The connection to your server was interrupted.
                    Do you want to reconnect?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal"
                        onclick="reconnect(true);">Yes</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                        onclick="reconnect(false);">No</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div id="conInf" class="col-11 align-self-center">
            </div>
            <div class="row">
                <div class="col-12">
                    <div id="msg" class="alert alert-primary" role="alert"></div>
                    <div id="errMsg" class="alert alert-danger" role="alert"> </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div id="conPan" class="container col-11 align-self-center">
                <div class="row">
                    <input id="hostInp" type="text" placeholder="Host to Connect" class="form-control col-8"
                        value="">
                    <input id="portInp" type="number" placeholder="Port" class="form-control col-2" value="22">
                    <label
                        title="If checked then connection is not proxied through the websocket proxy of ssheasy, but it goes directly to the provided host and port. On the provided addrees a websocket proxy is expected to listen. Useful if you have your own proxy setup (like websockify or something similar)."
                        class="col-2">
                        <input id="bypassProxyInp" type="checkbox" /> Bypass proxy
                    </label>
                </div>
                <div class="row">
                    <input id="usrInp" type="text" placeholder="User" class="form-control col-4" value="">
                    <input id="passInp" type="password" placeholder="Password" class="form-control col-8"
                        value="">
                </div>
                <div class="row">
                    <textarea id="pkInp" rows=1 placeholder="Private Key" class="form-control col-9"></textarea>
                    <label class="btn btn-link col-3">
                        Select key file <input id="pkFile" type="file" hidden>
                    </label>
                </div>
                <div class="row">
                    <button id="conBtn" type="button" class="btn btn-primary col-3"
                        onclick="$('#conBtn').prop('disabled',true);showMsg('Connecting...');initConnection(term.rows, term.cols,$('#hostInp').val(),Number($('#portInp').val()),$('#usrInp').val(),$('#passInp').val(),$('#pkInp').val(), $('#bypassProxyInp').is(':checked'), false);">Connect</button>
                </div>

            </div>
        </div>
        <div class="row">
            <div id="terminal" class="col-12"></div>
        </div>
        <div class="row col-10 offset-md-1">
            <input id="searchTxt" type="text" placeholder="Find" class="form-control col-md-3">
            <div class="col-md-2" style="padding-left: 20pt;padding-top: 7px;">
                <label class="form-check-label"> <input type="checkbox" class="form-check-input" id="matchCaseChb">Match
                    Case</label>
            </div>
            <button type="button" class="btn btn-link col-md-2"
                onclick="searchAddon.findNext($('#searchTxt').val(),{caseSensitive:  $('#matchCaseChb').prop('checked')})">Find
                Next</button>
            <button type="button" class="btn btn-link col-md-2"
                onclick="searchAddon.findPrevious($('#searchTxt').val(),{caseSensitive:  $('#matchCaseChb').prop('checked')})">Find
                Previous</button>

        </div>
    </div>

    <script>
        var term;
        function initXTerm() {
            term = new Terminal();
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            const searchAddon = new SearchAddon.SearchAddon();
            term.loadAddon(searchAddon);
            term.open(document.getElementById('terminal'));
            fitAddon.fit();
            term.write('\n\r');
            fitAddon.fit();
        }
        initXTerm();
    </script>
</body>

</html>